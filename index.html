<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OnLasdan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&family=Roboto:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <style id="bg-style"></style>
    <style id="dynamic-style"></style>
    
    <style>
        /* --- Global Variables & Base --- */
        :root {
            --theme-accent: #ad1457;
            --theme-light: #f48fb1;
            --theme-gradient-start: #f8bbd0;
            --theme-gradient-end: var(--theme-accent);
            --theme-text: #311b92;
            --size-scale: 1.0;
            --main-font: 'Quicksand', sans-serif;
            
            /* --- Advanced UI Variables --- */
            --glass-blur: 12px;
            --glass-opacity: 0.25;
            --glass-border-color: rgba(255, 255, 255, 0.3);
            --glass-border-width: 1px;
            --glass-border-radius: 1.5rem;
            --text-shadow: 0 1px 2px rgba(255, 255, 255, 0.4);
            --transition-speed: 0.3s;
        }

        body {
            font-family: var(--main-font);
            color: var(--theme-text);
            text-shadow: var(--text-shadow);
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        
        /* --- Background & Overlay --- */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-color: rgba(244, 143, 177, 0.3);
            background-blend-mode: soft-light;
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out;
        }
        
        /* --- Glassmorphism Panel --- */
        .glass-panel {
            background: rgba(255, 255, 255, var(--glass-opacity));
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: var(--glass-border-radius);
            border: var(--glass-border-width) solid var(--glass-border-color);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: all var(--transition-speed) ease;
        }

        /* --- Layout Containers --- */
        .layout-container { transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .layout-center { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
        .layout-center > .glass-panel { max-width: 42rem; width: 100%; animation: fadeIn 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; opacity: 0; transform: translateY(20px) scale(var(--size-scale)); }
        .layout-sidebar { display: flex; min-height: 100vh; }
        .layout-sidebar .sidebar { width: 300px; padding: 1.5rem; border-right: 1px solid rgba(255,255,255,0.2); }
        .layout-sidebar .main-content { flex-grow: 1; padding: 1.5rem; display: flex; flex-direction: column; justify-content: center; }
        .layout-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; padding: 1.5rem; min-height: 100vh; }
        .layout-grid .glass-panel { animation: fadeIn 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; opacity: 0; transform: scale(var(--size-scale)); }

        @keyframes fadeIn { to { opacity: 1; transform: translateY(0) scale(var(--size-scale)); } }

        /* --- Common Components --- */
        .search-input {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--theme-gradient-start);
            font-size: 0.875rem;
            padding: 0.625rem 1rem;
            height: 2.75rem;
            transition: all var(--transition-speed) ease;
        }
        .search-input:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--theme-accent);
            box-shadow: 0 0 0 3px rgba(173, 20, 87, 0.25);
            outline: none;
        }
        .search-button {
            height: 2.75rem;
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, var(--theme-gradient-start), var(--theme-gradient-end));
            transition: all var(--transition-speed) ease;
            border: none;
        }
        .search-button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(173, 20, 87, 0.4); }
        
        .quick-link {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.5);
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            display: inline-block;
            cursor: move;
        }
        .quick-link:hover {
            background: var(--theme-light);
            transform: scale(1.05);
            border-color: var(--theme-accent);
            box-shadow: 0 4px 12px rgba(173, 20, 87, 0.3);
        }
        .quick-link.dragging { opacity: 0.5; }

        /* --- Settings Panel --- */
        #settings-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--theme-gradient-start), var(--theme-gradient-end));
            border-radius: 50%;
            color: white;
            box-shadow: 0 4px 15px rgba(173, 20, 87, 0.4);
            transition: all var(--transition-speed) ease, opacity 0.2s ease, transform 0.2s ease;
            z-index: 1001;
            touch-action: manipulation;
        }
        #settings-toggle:hover { transform: rotate(90deg) scale(1.1); }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-speed) ease;
        }
        .settings-overlay.active { opacity: 1; pointer-events: auto; }

        #settings-panel {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            z-index: 1000;
            max-height: 90vh;
            overflow-y: auto;
            transition: bottom 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity var(--transition-speed) ease;
            opacity: 0;
            pointer-events: none;
            border-radius: var(--glass-border-radius) var(--glass-border-radius) 0 0;
            padding: 1.5rem;
        }
        #settings-panel.open {
            bottom: 0;
            opacity: 1;
            pointer-events: auto;
        }
        
        #settings-form fieldset {
            border: 1px solid var(--theme-light);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        #settings-form legend {
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0 0.5rem;
        }
        .file-input-wrapper { position: relative; display: inline-block; cursor: pointer; width: 100%; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .file-input-button {
            display: block;
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid var(--theme-gradient-end);
            border-radius: 0.5rem;
            background: linear-gradient(135deg, var(--theme-light), var(--theme-gradient-start));
            color: var(--theme-text);
            font-weight: 500;
            font-size: 0.875rem;
            text-align: center;
            transition: all var(--transition-speed) ease;
        }
        .file-input-button:hover { background: linear-gradient(135deg, var(--theme-gradient-start), var(--theme-accent)); }
        
        /* --- Widgets --- */
        .widget {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }
        .widget h3 { margin-bottom: 0.5rem; color: var(--theme-accent); display: flex; justify-content: space-between; align-items: center; }
        .widget-close-btn {
            cursor: pointer; background: none; border: none; color: var(--theme-text); font-size: 1.2rem; line-height: 1; padding: 0; opacity: 0.7;
        }
        .widget-close-btn:hover { opacity: 1; }
        .pomodoro-timer { text-align: center; }
        .pomodoro-display { font-size: 2rem; font-weight: 700; margin: 1rem 0; }
        .pomodoro-controls button { padding: 0.5rem 1rem; margin: 0 0.25rem; border-radius: 0.5rem; border: none; background: var(--theme-light); }
        .todo-list ul { list-style: none; padding: 0; }
        .todo-list li { display: flex; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); gap: 0.5rem; }
        .todo-list input[type="checkbox"] { margin-right: 0.25rem; }
        .todo-list input[type="text"] { flex-grow: 1; background: transparent; border: none; color: var(--theme-text); }
        .todo-list input[type="text"]:focus { outline: none; border-bottom: 1px solid var(--theme-accent); }
        .todo-list .todo-meta { font-size: 0.75rem; opacity: 0.8; white-space: nowrap; }
        .todo-list .priority-high { color: #ef5350; font-weight: bold; }
        .todo-list .due-date-past { color: #ff9800; }
        .weather-info { display: flex; align-items: center; justify-content: space-around; flex-wrap: wrap; gap: 1rem; }
        .weather-main { text-align: center; }
        .weather-icon img { width: 64px; height: 64px; }
        .weather-temp { font-size: 2.5rem; font-weight: 700; }
        .weather-details { font-size: 0.9rem; text-align: left; }
        .weather-details p { margin: 0.25rem 0; }

        /* --- Dark Mode --- */
        body.dark-mode {
            --theme-accent: #f48fb1;
            --theme-light: #ad1457;
            --theme-gradient-start: #880e4f;
            --theme-gradient-end: var(--theme-accent);
            --theme-text: #f8bbd0;
            --text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }
        body.dark-mode::before { background-color: rgba(0, 0, 0, 0.5); background-blend-mode: multiply; }
        body.dark-mode .glass-panel { background: rgba(0, 0, 0, var(--glass-opacity)); border: 1px solid rgba(255, 255, 255, 0.1); }
        body.dark-mode .search-input { background: rgba(0, 0, 0, 0.5); color: var(--theme-text); }
        body.dark-mode .search-input:focus { background: rgba(0, 0, 0, 0.7); }
        body.dark-mode .quick-link { background: rgba(255, 255, 255, 0.1); color: var(--theme-text); }
        body.dark-mode .quick-link:hover { background: var(--theme-light); }
        body.dark-mode .widget { background: rgba(0, 0, 0, 0.15); border: 1px solid rgba(255, 255, 255, 0.1); }

        /* --- Status Message --- */
        #status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: all 0.4s ease;
        }
        #status-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #status-message.success { background-color: #4CAF50; }
        #status-message.error { background-color: #f44336; }
    </style>
</head>
<body class="layout-center">

    <!-- Kontainer Utama: Layout Dinamis -->
    <div id="layout-container" class="layout-container">
        <!-- Panel untuk Layout Tengah -->
        <div id="center-panel" class="glass-panel p-6 md:p-8 space-y-5">
            <!-- Jam & Salam -->
            <div id="clock-container" class="text-center">
                <div id="greeting" class="text-2xl md:text-3xl font-bold" style="color: var(--theme-light);">Selamat Pagi</div>
                <div id="clock" class="text-5xl md:text-6xl font-black" style="color: var(--theme-accent); letter-spacing: -2px; font-family: monospace; white-space: nowrap;"></div>
                <div id="date" class="text-sm md:text-base opacity-75">Senin, 1 Januari 2024</div>
            </div>

            <!-- Formulir Pencarian -->
            <form id="search-form" class="flex w-full max-w-lg mx-auto shadow-lg rounded-full overflow-hidden">
                <input type="text" name="q" placeholder="Cari di Google..." class="search-input w-full rounded-l-full">
                <button type="submit" class="search-button font-semibold text-white rounded-r-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </button>
            </form>

            <!-- Link Cepat -->
            <nav id="quick-links-nav" class="flex flex-wrap justify-center gap-3 pt-3">
                <!-- Link akan di-render di sini oleh JavaScript -->
            </nav>
        </div>

        <!-- Panel untuk Layout Sidebar -->
        <div id="sidebar-panel" class="glass-panel sidebar" style="display: none;">
            <div id="sidebar-links" class="space-y-2">
                <!-- Link kategori akan di-render di sini -->
            </div>
        </div>
        <div id="sidebar-main" class="glass-panel main-content" style="display: none;">
            <!-- Konten utama sidebar (jam, search) -->
        </div>

        <!-- Panel untuk Layout Grid -->
        <div id="grid-clock" class="glass-panel p-4" style="display: none;">
            <div id="greeting-grid" class="text-xl font-bold" style="color: var(--theme-light);">Selamat Pagi</div>
            <div id="clock-grid" class="text-4xl font-black" style="color: var(--theme-accent); font-family: monospace; white-space: nowrap;"></div>
        </div>
        <div id="grid-search" class="glass-panel p-4" style="display: none;">
            <form id="search-form-grid" class="flex">
                <input type="text" name="q" placeholder="Cari..." class="search-input w-full rounded-l-lg">
                <button type="submit" class="search-button rounded-r-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </form>
        </div>
        <div id="grid-links" class="glass-panel p-4" style="display: none;">
            <h3 class="font-bold mb-2" style="color: var(--theme-accent);">Link Cepat</h3>
            <div id="grid-links-container" class="grid grid-cols-2 gap-2">
                <!-- Link akan di-render di sini -->
            </div>
        </div>
        <div id="grid-widgets" class="glass-panel p-4" style="display: none;">
            <h3 class="font-bold mb-2" style="color: var(--theme-accent);">Widget</h3>
            <!-- Widget akan di-render di sini -->
        </div>
    </div>
    
    <!-- Overlay & Tombol Pengaturan -->
    <div id="settings-overlay" class="settings-overlay"></div>
    <button id="settings-toggle" title="Pengaturan">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>

    <!-- Panel Pengaturan -->
    <div id="settings-panel" class="glass-panel">
        <h2 class="text-xl font-bold mb-5 text-center" style="color: var(--theme-accent);">Pengaturan</h2>
        <form id="settings-form" class="space-y-4">
            <!-- 1. Umum -->
            <fieldset>
                <legend>Umum</legend>
                <div class="mb-3">
                    <label for="layout-select" class="block text-sm font-medium mb-1">Layout</label>
                    <select id="layout-select" class="search-input w-full rounded-lg">
                        <option value="center">Tengah</option>
                        <option value="sidebar">Sidebar Kiri</option>
                        <option value="grid">Grid</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="dark-mode-toggle" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="dark-mode-toggle" class="mr-2">
                        <span class="text-sm font-medium">Mode Gelap</span>
                    </label>
                </div>
            </fieldset>

            <!-- 2. Tampilan -->
            <fieldset>
                <legend>Tampilan</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="font-select" class="block text-sm font-medium mb-1">Font</label>
                        <select id="font-select" class="search-input w-full rounded-lg">
                            <option value="'Quicksand', sans-serif">Quicksand</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="'Dancing Script', cursive">Dancing Script</option>
                        </select>
                    </div>
                    <div>
                        <label for="size-scale" class="block text-sm font-medium mb-1">Skala Ukuran</label>
                        <input type="number" id="size-scale" min="0.5" max="2.0" step="0.01" value="1" class="search-input w-full rounded-lg">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label for="color-accent" class="block text-xs font-medium">Aksen</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="text" id="color-accent" placeholder="#ad1457" class="search-input w-full rounded-lg font-mono text-sm">
                            <div id="preview-accent" class="w-8 h-8 rounded border-2 border-white shadow-sm"></div>
                        </div>
                    </div>
                    <div>
                        <label for="color-light" class="block text-xs font-medium">Terang</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="text" id="color-light" placeholder="#f48fb1" class="search-input w-full rounded-lg font-mono text-sm">
                            <div id="preview-light" class="w-8 h-8 rounded border-2 border-white shadow-sm"></div>
                        </div>
                    </div>
                    <div>
                        <label for="color-text" class="block text-xs font-medium">Teks</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="text" id="color-text" placeholder="#311b92" class="search-input w-full rounded-lg font-mono text-sm">
                            <div id="preview-text" class="w-8 h-8 rounded border-2 border-white shadow-sm"></div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- 3. UI Lanjutan -->
            <fieldset>
                <legend>UI Lanjutan (Efek Kaca & Animasi)</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="glass-blur" class="block text-sm font-medium mb-1">Blur (px)</label><input type="number" id="glass-blur" min="0" max="50" value="12" class="search-input w-full rounded-lg"></div>
                    <div><label for="glass-opacity" class="block text-sm font-medium mb-1">Opacity (0.0 - 1.0)</label><input type="number" id="glass-opacity" min="0" max="1" step="0.01" value="0.25" class="search-input w-full rounded-lg"></div>
                    <div><label for="glass-border-width" class="block text-sm font-medium mb-1">Lebar Border (px)</label><input type="number" id="glass-border-width" min="0" max="10" value="1" class="search-input w-full rounded-lg"></div>
                    <div><label for="glass-border-radius" class="block text-sm font-medium mb-1">Radius Border (rem)</label><input type="number" id="glass-border-radius" min="0" max="5" step="0.1" value="1.5" class="search-input w-full rounded-lg"></div>
                    <div><label for="transition-speed" class="block text-sm font-medium mb-1">Kecepatan Animasi (s)</label><input type="number" id="transition-speed" min="0.1" max="2" step="0.1" value="0.3" class="search-input w-full rounded-lg"></div>
                    <div>
                        <label for="glass-border-color" class="block text-sm font-medium mb-1">Warna Border</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="text" id="glass-border-color" placeholder="rgba(255,255,255,0.3)" class="search-input w-full rounded-lg font-mono text-sm">
                            <div id="preview-border" class="w-8 h-8 rounded border-2 border-white shadow-sm"></div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- 4. Elemen & Pencarian -->
            <fieldset>
                <legend>Elemen & Pencarian</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Tampilkan Elemen</label>
                        <div class="space-y-2">
                            <label class="flex items-center"><input type="checkbox" id="show-greeting" class="mr-2" checked><span>Salam</span></label>
                            <label class="flex items-center"><input type="checkbox" id="show-clock" class="mr-2" checked><span>Jam</span></label>
                            <label class="flex items-center"><input type="checkbox" id="show-search" class="mr-2" checked><span>Pencarian</span></label>
                            <label class="flex items-center"><input type="checkbox" id="show-links" class="mr-2" checked><span>Link Cepat</span></label>
                        </div>
                    </div>
                    <div>
                        <label for="custom-greeting" class="block text-sm font-medium mb-1">Teks Salam Kustom</label>
                        <input type="text" id="custom-greeting" placeholder="Kosongkan untuk menggunakan default" class="search-input w-full rounded-lg">
                        <label for="clock-format" class="block text-sm font-medium mb-1 mt-2">Format Jam</label>
                        <select id="clock-format" class="search-input w-full rounded-lg">
                            <option value="12">12 Jam</option>
                            <option value="24">24 Jam</option>
                        </select>
                        <label for="search-engine" class="block text-sm font-medium mb-1 mt-2">Mesin Pencari</label>
                        <select id="search-engine" class="search-input w-full rounded-lg">
                            <option value="https://www.google.com/search">Google</option>
                            <option value="https://duckduckgo.com/?q=">DuckDuckGo</option>
                            <option value="https://www.bing.com/search?q=">Bing</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- 5. Link Cepat -->
            <fieldset>
                <legend>Link Cepat (JSON)</legend>
                <textarea id="link-json" rows="3" placeholder='[{"name": "YouTube", "url": "https://youtube.com", "category": "Hiburan"}]' class="search-input w-full rounded-lg font-mono resize-y"></textarea>
            </fieldset>

            <!-- 6. Widget & API -->
            <fieldset>
                <legend>Widget & API</legend>
                <div class="mb-3">
                    <label for="weather-api-key" class="block text-sm font-medium mb-1">API Key Cuaca (OpenWeatherMap)</label>
                    <input type="text" id="weather-api-key" placeholder="Masukkan API Key..." class="search-input w-full rounded-lg">
                </div>
                <div class="mb-3">
                    <label for="rss-feed-url" class="block text-sm font-medium mb-1">URL RSS Feed</label>
                    <input type="url" id="rss-feed-url" placeholder="https://example.com/rss.xml" class="search-input w-full rounded-lg">
                </div>
                <div class="mb-3">
                    <label for="rss-auto-refresh" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="rss-auto-refresh" class="mr-2">
                        <span class="text-sm font-medium">Auto-refresh RSS (15 menit)</span>
                    </label>
                </div>
            </fieldset>

            <!-- 7. Background -->
            <fieldset>
                <legend>Latar Belakang</legend>
                <div class="space-y-2">
                    <input type="url" id="bg-url" placeholder="https://example.com/image.jpg" class="search-input w-full rounded-lg">
                    <div class="file-input-wrapper">
                        <input type="file" accept="image/*" id="bg-local-file">
                        <label for="bg-local-file" class="file-input-button">Pilih File Gambar...</label>
                    </div>
                    <p id="bg-status" class="text-xs text-gray-600 italic"></p>
                </div>
            </fieldset>

            <!-- 8. Data & Cadangan -->
            <fieldset>
                <legend>Data & Cadangan</legend>
                <div class="flex gap-3">
                    <button type="button" id="export-settings" class="px-4 py-2 text-sm font-semibold rounded-lg bg-green-500 text-white hover:bg-green-600 transition">Ekspor Pengaturan</button>
                    <div class="file-input-wrapper flex-grow">
                        <input type="file" accept=".json" id="import-settings-file">
                        <label for="import-settings-file" class="file-input-button">Impor Pengaturan</label>
                    </div>
                </div>
            </fieldset>

            <div class="flex justify-end space-x-3 pt-3 border-t border-pink-200">
                <button type="button" id="close-settings" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition">Tutup</button>
                <button type="submit" class="px-4 py-2 text-sm font-semibold rounded-lg text-white search-button">Simpan</button>
            </div>
        </form>
    </div>

    <!-- Status Message -->
    <div id="status-message"></div>

    <!-- JavaScript Utama -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- KONSTANTA & DEFAULT ---
            const DEFAULT_BG_URL = 'https://images.unsplash.com/photo-1513475382585-d06e58bcb0e0?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80';
            const DEFAULT_LINKS = [
                { name: "YouTube", url: "https://youtube.com", category: "Hiburan" },
                { name: "Twitter", url: "https://twitter.com", category: "Sosial" },
                { name: "Reddit", url: "https://reddit.com", category: "Sosial" },
                { name: "GitHub", url: "https://github.com", category: "Pekerjaan" },
                { name: "MangaDex", url: "https://mangadex.org", category: "Hiburan" },
            ];
            const STORAGE_KEYS = {
                bg: 'enchant_bg', links: 'enchant_links', colors: 'enchant_colors',
                sizes: 'enchant_sizes', layout: 'enchant_layout', darkMode: 'enchant_dark_mode',
                font: 'enchant_font', weatherApiKey: 'enchant_weather_api_key', rssUrl: 'enchant_rss_url',
                uiAdvanced: 'enchant_ui_advanced', elementVisibility: 'enchant_element_visibility',
                searchEngine: 'enchant_search_engine', clockFormat: 'enchant_clock_format', customGreeting: 'enchant_custom_greeting',
                rssAutoRefresh: 'enchant_rss_auto_refresh', hiddenWidgets: 'enchant_hidden_widgets'
            };

            // --- ELEMEN DOM ---
            const elements = {
                body: document.body, layoutContainer: document.getElementById('layout-container'),
                clock: document.getElementById('clock'), clockGrid: document.getElementById('clock-grid'),
                greeting: document.getElementById('greeting'), greetingGrid: document.getElementById('greeting-grid'),
                date: document.getElementById('date'), quickLinksNav: document.getElementById('quick-links-nav'),
                gridLinksContainer: document.getElementById('grid-links-container'),
                settingsForm: document.getElementById('settings-form'), settingsPanel: document.getElementById('settings-panel'),
                settingsToggle: document.getElementById('settings-toggle'), closeSettings: document.getElementById('close-settings'),
                settingsOverlay: document.getElementById('settings-overlay'), statusMessage: document.getElementById('status-message'),
                bgStyle: document.getElementById('bg-style'), dynamicStyle: document.getElementById('dynamic-style'),
                clockContainer: document.getElementById('clock-container'),
                searchForm: document.getElementById('search-form'), searchFormGrid: document.getElementById('search-form-grid'),
                // Inputs
                bgUrl: document.getElementById('bg-url'), bgLocalFile: document.getElementById('bg-local-file'), bgStatus: document.getElementById('bg-status'),
                linkJson: document.getElementById('link-json'), colorAccent: document.getElementById('color-accent'), colorLight: document.getElementById('color-light'),
                colorText: document.getElementById('color-text'), sizeScale: document.getElementById('size-scale'),
                previewAccent: document.getElementById('preview-accent'), previewLight: document.getElementById('preview-light'), previewText: document.getElementById('preview-text'),
                layoutSelect: document.getElementById('layout-select'), darkModeToggle: document.getElementById('dark-mode-toggle'),
                fontSelect: document.getElementById('font-select'), weatherApiKey: document.getElementById('weather-api-key'),
                rssFeedUrl: document.getElementById('rss-feed-url'), rssAutoRefresh: document.getElementById('rss-auto-refresh'),
                // Advanced UI
                glassBlur: document.getElementById('glass-blur'), glassOpacity: document.getElementById('glass-opacity'),
                glassBorderWidth: document.getElementById('glass-border-width'), glassBorderRadius: document.getElementById('glass-border-radius'),
                transitionSpeed: document.getElementById('transition-speed'), glassBorderColor: document.getElementById('glass-border-color'),
                previewBorder: document.getElementById('preview-border'),
                // Element & Search
                showGreeting: document.getElementById('show-greeting'), showClock: document.getElementById('show-clock'),
                showSearch: document.getElementById('show-search'), showLinks: document.getElementById('show-links'),
                customGreeting: document.getElementById('custom-greeting'), clockFormat: document.getElementById('clock-format'),
                searchEngine: document.getElementById('search-engine'),
                // FITUR TAMBAHAN
                exportSettings: document.getElementById('export-settings'), importSettingsFile: document.getElementById('import-settings-file')
            };

            // --- FUNGSI HELPER ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);
            const readFileAsDataURL = (file) => new Promise((resolve, reject) => { if (!file) return resolve(null); const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); reader.readAsDataURL(file); });
            const showStatus = (message, type = 'success') => { elements.statusMessage.textContent = message; elements.statusMessage.className = `show ${type}`; setTimeout(() => elements.statusMessage.classList.remove('show'), 3000); };
            const isValidHex = (hex) => /^#[0-9A-Fa-f]{6}$/.test(hex);
            const sanitizeHex = (hex) => { if (!hex.startsWith('#')) hex = '#' + hex; if (hex.length === 4) hex = '#' + hex[1] + hex[1] + hex[2] + hex[2] + hex[3] + hex[3]; return hex; };
            const updateColorPreview = (inputEl, previewEl) => { const color = sanitizeHex(inputEl.value); previewEl.style.backgroundColor = isValidHex(color) ? color : 'transparent'; };
            
            let isSettingsFormInitialized = false;

            function openSettings() { 
                elements.settingsPanel.classList.add('open'); 
                elements.settingsOverlay.classList.add('active');
                elements.settingsToggle.style.opacity = '0';
                elements.settingsToggle.style.pointerEvents = 'none';

                if (!isSettingsFormInitialized) {
                    requestAnimationFrame(() => {
                        populateSettingsForm(appState);
                        attachSettingsFormListeners();
                        isSettingsFormInitialized = true;
                    });
                }
            }
            function closeSettingsPanel() { 
                elements.settingsPanel.classList.remove('open'); 
                elements.settingsOverlay.classList.remove('active');
                elements.settingsToggle.style.opacity = '';
                elements.settingsToggle.style.pointerEvents = '';
            }

            // --- MODUL: CORE (Jam, Pencarian, Link) ---
            const Core = {
                getDragAfterElement(container, y) {
                    const draggableElements = [...container.querySelectorAll('a:not(.dragging)')];
                    return draggableElements.reduce((closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = y - box.top - box.height / 2;
                        if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; }
                    }, { offset: Number.NEGATIVE_INFINITY }).element;
                },
                updateClock() {
                    const now = new Date();
                    let hours = now.getHours();
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const seconds = now.getSeconds().toString().padStart(2, '0');
                    const is24Hour = elements.clockFormat.value === '24';
                    const timeString = is24Hour ? `${hours.toString().padStart(2, '0')}:${minutes}:${seconds}` : `${(hours % 12 || 12).toString().padStart(2, '0')}:${minutes}:${seconds} ${hours >= 12 ? 'PM' : 'AM'}`;
                    if (elements.clock) elements.clock.textContent = timeString;
                    if (elements.clockGrid) elements.clockGrid.textContent = timeString;
                    
                    const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                    const dateString = `${dayNames[now.getDay()]}, ${now.getDate()} ${monthNames[now.getMonth()]} ${now.getFullYear()}`;
                    if(elements.date) elements.date.textContent = dateString;
                    
                    const hour = now.getHours();
                    let greetingText = elements.customGreeting.value.trim();
                    if (!greetingText) {
                        greetingText = 'Selamat Malam';
                        if (hour < 10) greetingText = 'Selamat Pagi';
                        else if (hour < 15) greetingText = 'Selamat Siang';
                        else if (hour < 18) greetingText = 'Selamat Sore';
                    }
                    if (elements.greeting) elements.greeting.textContent = greetingText;
                    if (elements.greetingGrid) elements.greetingGrid.textContent = greetingText;
                },
                loadLinks() {
                    const savedJson = localStorage.getItem(STORAGE_KEYS.links);
                    try { if (savedJson) { const links = JSON.parse(savedJson); if (Array.isArray(links) && links.every(l => l && typeof l === 'object' && l.name && l.url)) return links; } }
                    catch (e) { console.error("Gagal memuat link, menggunakan default.", e); localStorage.removeItem(STORAGE_KEYS.links); }
                    return DEFAULT_LINKS;
                },
                renderLinksForCenter(links) {
                    if (!elements.quickLinksNav) return;
                    elements.quickLinksNav.innerHTML = '';
                    links.forEach((link, index) => {
                        const a = document.createElement('a');
                        a.href = link.url; a.className = 'quick-link'; a.textContent = link.name; a.target = '_blank';
                        a.draggable = true;
                        a.dataset.index = index;
                        a.addEventListener('dragstart', this.handleDragStart);
                        a.addEventListener('dragover', this.handleDragOver);
                        a.addEventListener('drop', this.handleDrop);
                        a.addEventListener('dragend', this.handleDragEnd);
                        elements.quickLinksNav.appendChild(a);
                    });
                },
                renderLinksForGrid(links) {
                    if (!elements.gridLinksContainer) return;
                    elements.gridLinksContainer.innerHTML = '';
                    links.forEach((link, index) => {
                        const a = document.createElement('a');
                        a.href = link.url; a.className = 'block p-2 rounded text-center hover:bg-white/20 transition'; a.textContent = link.name; a.target = '_blank';
                        a.draggable = true;
                        a.dataset.index = index;
                        a.addEventListener('dragstart', this.handleDragStart);
                        a.addEventListener('dragover', this.handleDragOver);
                        a.addEventListener('drop', this.handleDrop);
                        a.addEventListener('dragend', this.handleDragEnd);
                        elements.gridLinksContainer.appendChild(a);
                    });
                },
                renderLinksForSidebar(links) {
                    const sidebarLinks = $('#sidebar-links');
                    if (!sidebarLinks) return;
                    const categories = [...new Set(links.map(l => l.category).filter(Boolean))];
                    sidebarLinks.innerHTML = '';
                    if (categories.length === 0) {
                        links.forEach(link => {
                            const a = document.createElement('a'); a.href = link.url; a.className = 'block p-2 rounded hover:bg-white/20 transition'; a.textContent = link.name; a.target = '_blank';
                            sidebarLinks.appendChild(a);
                        });
                    } else {
                        categories.forEach(cat => {
                            const h4 = document.createElement('h4'); h4.className = 'font-bold text-sm mt-3 mb-1'; h4.textContent = cat;
                            sidebarLinks.appendChild(h4);
                            links.filter(l => l.category === cat).forEach(link => {
                                const a = document.createElement('a'); a.href = link.url; a.className = 'block p-2 rounded hover:bg-white/20 transition pl-4'; a.textContent = link.name; a.target = '_blank';
                                sidebarLinks.appendChild(a);
                            });
                        });
                    }
                },
                handleDragStart(e) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', e.target.innerHTML);
                    e.dataTransfer.setData('text/plain', e.target.dataset.index);
                },
                handleDragOver(e) {
                    if (e.preventDefault) { e.preventDefault(); }
                    e.dataTransfer.dropEffect = 'move';
                    const dragging = document.querySelector('.dragging');
                    const afterElement = Core.getDragAfterElement(e.currentTarget.parentNode, e.clientY);
                    if (afterElement == null) { e.currentTarget.parentNode.appendChild(dragging); } else { e.currentTarget.parentNode.insertBefore(dragging, afterElement); }
                    return false;
                },
                handleDrop(e) {
                    if (e.stopPropagation) { e.stopPropagation(); }
                    const links = Core.loadLinks();
                    const newOrder = Array.from(e.currentTarget.parentNode.children).map(el => links[parseInt(el.dataset.index)]);
                    localStorage.setItem(STORAGE_KEYS.links, JSON.stringify(newOrder));
                    Core.renderLinksForCenter(newOrder);
                    Core.renderLinksForGrid(newOrder);
                    showStatus('Urutan link diperbarui!');
                    return false;
                },
                handleDragEnd(e) { e.target.classList.remove('dragging'); },
                init() {
                    this.updateClock();
                    setInterval(() => this.updateClock(), 1000);
                    const links = this.loadLinks();
                    this.renderLinksForCenter(links);
                    this.renderLinksForGrid(links);
                    this.renderLinksForSidebar(links);
                }
            };

            // --- MODUL: WIDGETS ---
            const Widgets = {
                createPomodoroTimer() {
                    const widget = document.createElement('div'); widget.className = 'widget pomodoro-timer'; widget.id = 'widget-pomodoro';
                    widget.innerHTML = `<h3>Timer Pomodoro <button class="widget-close-btn" data-widget="pomodoro">&times;</button></h3><div class="pomodoro-display">25:00</div><div class="pomodoro-controls"><button id="pomodoro-start">Start</button><button id="pomodoro-reset">Reset</button></div>`;
                    let timer, timeLeft = 25 * 60;
                    const display = widget.querySelector('.pomodoro-display'); const startBtn = widget.querySelector('#pomodoro-start'); const resetBtn = widget.querySelector('#pomodoro-reset');
                    function updateDisplay() { const minutes = Math.floor(timeLeft / 60); const seconds = timeLeft % 60; display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`; }
                    startBtn.addEventListener('click', () => { if (timer) { clearInterval(timer); timer = null; startBtn.textContent = 'Start'; } else { timer = setInterval(() => { timeLeft--; updateDisplay(); if (timeLeft <= 0) { clearInterval(timer); timer = null; startBtn.textContent = 'Start'; alert('Waktu istirahat!'); timeLeft = 25 * 60; updateDisplay(); } }, 1000); startBtn.textContent = 'Pause'; } });
                    resetBtn.addEventListener('click', () => { clearInterval(timer); timer = null; timeLeft = 25 * 60; updateDisplay(); startBtn.textContent = 'Start'; });
                    updateDisplay(); return widget;
                },
                createTodoList() {
                    const widget = document.createElement('div'); widget.className = 'widget todo-list'; widget.id = 'widget-todo';
                    widget.innerHTML = `<h3>To-Do List <button class="widget-close-btn" data-widget="todo">&times;</button></h3><ul id="todo-list-items"></ul><div class="flex gap-2 mt-2"><input type="text" id="new-todo-input" placeholder="Tugas baru..." class="search-input rounded-lg flex-grow"><select id="new-todo-priority" class="search-input rounded-lg"><option value="low">Rendah</option><option value="medium" selected>Sedang</option><option value="high">Tinggi</option></select><input type="date" id="new-todo-date" class="search-input rounded-lg"></div>`;
                    const list = widget.querySelector('#todo-list-items'); const input = widget.querySelector('#new-todo-input'); const prioritySelect = widget.querySelector('#new-todo-priority'); const dateInput = widget.querySelector('#new-todo-date');
                    let todos;
                    try {
                        todos = JSON.parse(localStorage.getItem('enchant_todos')) || [];
                    } catch(e) {
                        todos = [];
                        localStorage.removeItem('enchant_todos');
                    }
                    function render() {
                        list.innerHTML = '';
                        const fragment = document.createDocumentFragment();
                        todos.forEach((todo, index) => {
                            const li = document.createElement('li');
                            const isPast = todo.dueDate && new Date(todo.dueDate) < new Date().setHours(0,0,0,0);
                            const priorityClass = todo.priority === 'high' ? 'priority-high' : '';
                            const dateClass = isPast ? 'due-date-past' : '';
                            li.innerHTML = `<input type="checkbox" ${todo.done ? 'checked' : ''} data-index="${index}"><input type="text" value="${todo.text}" data-index="${index}" class="${todo.done ? 'line-through' : ''}"><span class="todo-meta ${priorityClass} ${dateClass}">${todo.priority.toUpperCase()} ${todo.dueDate ? '| ' + new Date(todo.dueDate).toLocaleDateString('id-ID') : ''}</span>`;
                            fragment.appendChild(li);
                        });
                        list.appendChild(fragment);
                    }
                    widget.addEventListener('change', (e) => { if (e.target.type === 'checkbox') { const index = e.target.dataset.index; todos[index].done = e.target.checked; localStorage.setItem('enchant_todos', JSON.stringify(todos)); render(); } });
                    widget.addEventListener('input', (e) => { if (e.target.type === 'text') { const index = e.target.dataset.index; todos[index].text = e.target.value; localStorage.setItem('enchant_todos', JSON.stringify(todos)); } });
                    input.addEventListener('keypress', (e) => { if (e.key === 'Enter' && input.value.trim()) { todos.push({ text: input.value, done: false, priority: prioritySelect.value, dueDate: dateInput.value }); localStorage.setItem('enchant_todos', JSON.stringify(todos)); input.value = ''; dateInput.value = ''; render(); } });
                    render(); return widget;
                },
                createWeatherWidget() {
                    const widget = document.createElement('div'); widget.className = 'widget weather-widget'; widget.id = 'widget-weather';
                    widget.innerHTML = `<h3>Cuaca <button class="widget-close-btn" data-widget="weather">&times;</button></h3><div class="weather-info"><div class="weather-main"><div class="weather-icon"></div><div class="weather-temp">--Â°C</div><p class="weather-desc">Memuat...</p></div><div class="weather-details"><p>Kelembaban: --%</p><p>Angin: -- m/s</p><p>Lokasi: --</p></div></div>`;
                    const apiKey = localStorage.getItem(STORAGE_KEYS.weatherApiKey);
                    const weatherCache = JSON.parse(localStorage.getItem('enchant_weather_cache') || '{}');
                    const now = Date.now();
                    if (weatherCache.data && (now - weatherCache.timestamp) < 15 * 60 * 1000) {
                        this.populateWeatherData(widget, weatherCache.data);
                        return widget;
                    }

                    if (apiKey && navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(async (position) => {
                            const { latitude, longitude } = position.coords;
                            try {
                                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric&lang=id`);
                                if (!response.ok) throw new Error('Gagal mengambil data cuaca.');
                                const data = await response.json();
                                localStorage.setItem('enchant_weather_cache', JSON.stringify({ data, timestamp: now }));
                                this.populateWeatherData(widget, data);
                            } catch (error) {
                                widget.querySelector('.weather-desc').textContent = 'Gagal memuat cuaca.';
                                console.error(error);
                            }
                        }, (error) => { widget.querySelector('.weather-desc').textContent = 'Lokasi tidak diizinkan.'; });
                    } else {
                         widget.querySelector('.weather-desc').textContent = !navigator.geolocation ? 'Browser tidak mendukung geolokasi.' : 'API Key tidak ditemukan.';
                    }
                    return widget;
                },
                populateWeatherData(widget, data) {
                    widget.querySelector('.weather-temp').textContent = `${Math.round(data.main.temp)}Â°C`;
                    widget.querySelector('.weather-desc').textContent = data.weather[0].description;
                    widget.querySelector('.weather-icon').innerHTML = `<img src="https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png">`;
                    widget.querySelector('.weather-details').innerHTML = `<p>Kelembaban: ${data.main.humidity}%</p><p>Angin: ${data.wind.speed} m/s</p><p>Lokasi: ${data.name}</p>`;
                },
                createRSSWidget() {
                    const widget = document.createElement('div'); widget.className = 'widget rss-widget'; widget.id = 'widget-rss';
                    widget.innerHTML = `<h3>Berita Terbaru <button class="widget-close-btn" data-widget="rss">&times;</button></h3><button id="rss-refresh-btn" class="text-xs mb-2 px-2 py-1 rounded bg-white/20 hover:bg-white/30">Refresh</button><ul id="rss-list"></ul>`;
                    const rssUrl = localStorage.getItem(STORAGE_KEYS.rssUrl);
                    const list = widget.querySelector('#rss-list');
                    const refreshBtn = widget.querySelector('#rss-refresh-btn');
                    const fetchRSS = async () => {
                        if (!rssUrl) { list.innerHTML = '<li class="text-sm">URL RSS tidak diatur.</li>'; return; }
                        list.innerHTML = '<li class="text-sm">Memuat...</li>';
                        try {
                            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(rssUrl)}`;
                            const response = await fetch(proxyUrl);
                            if (!response.ok) throw new Error('Network response was not ok');
                            const str = await response.text();
                            const data = (new window.DOMParser()).parseFromString(str, "text/xml");
                            const items = data.querySelectorAll("item");
                            list.innerHTML = '';
                            const fragment = document.createDocumentFragment();
                            for (let i = 0; i < Math.min(items.length, 5); i++) {
                                const title = items[i].querySelector("title")?.textContent || 'Tanpa judul';
                                const link = items[i].querySelector("link")?.textContent || '#';
                                const li = document.createElement('li'); li.innerHTML = `<a href="${link}" target="_blank" class="text-sm block py-1 hover:underline">${title}</a>`; fragment.appendChild(li);
                            }
                            list.appendChild(fragment);
                        } catch (error) { console.error('Error fetching RSS:', error); list.innerHTML = '<li class="text-sm">Gagal memuat RSS.</li>'; }
                    };
                    refreshBtn.addEventListener('click', fetchRSS);
                    fetchRSS();
                    if (localStorage.getItem(STORAGE_KEYS.rssAutoRefresh) === 'true') {
                        setInterval(fetchRSS, 15 * 60 * 1000);
                    }
                    return widget;
                },
                loadAll() {
                    const gridWidgets = $('#grid-widgets');
                    if (!gridWidgets) return;
                    gridWidgets.innerHTML = '';
                    const hiddenWidgets = JSON.parse(localStorage.getItem(STORAGE_KEYS.hiddenWidgets) || '[]');
                    if (!hiddenWidgets.includes('pomodoro')) gridWidgets.appendChild(this.createPomodoroTimer());
                    if (!hiddenWidgets.includes('todo')) gridWidgets.appendChild(this.createTodoList());
                    if (!hiddenWidgets.includes('weather')) gridWidgets.appendChild(this.createWeatherWidget());
                    if (!hiddenWidgets.includes('rss')) gridWidgets.appendChild(this.createRSSWidget());
                }
            };
            
            // --- EVENT LISTENERS (Global) ---
            elements.settingsToggle.addEventListener('click', openSettings);
            elements.closeSettings.addEventListener('click', closeSettingsPanel);
            elements.settingsOverlay.addEventListener('click', closeSettingsPanel);
            elements.settingsPanel.addEventListener('click', (event) => { event.stopPropagation(); });
            
            document.addEventListener('click', (e) => {
                if (e.target.matches('.widget-close-btn')) {
                    const widgetName = e.target.dataset.widget;
                    const hiddenWidgets = JSON.parse(localStorage.getItem(STORAGE_KEYS.hiddenWidgets) || '[]');
                    if (!hiddenWidgets.includes(widgetName)) {
                        hiddenWidgets.push(widgetName);
                        localStorage.setItem(STORAGE_KEYS.hiddenWidgets, JSON.stringify(hiddenWidgets));
                        e.target.closest('.widget').remove();
                        showStatus(`Widget ${widgetName} disembunyikan.`);
                    }
                }
            });

            // --- KEYBOARD SHORTCUTS ---
            document.addEventListener('keydown', (e) => {
                if (e.key === 's' || e.key === 'S') { if (!e.target.matches('input, textarea')) { e.preventDefault(); if (elements.settingsPanel.classList.contains('open')) closeSettingsPanel(); else openSettings(); } }
                if (e.key === '/') { if (!e.target.matches('input, textarea')) { e.preventDefault(); $('input[name="q"]').focus(); } }
                if (e.key === 't' || e.key === 'T') { if (!e.target.matches('input, textarea')) { e.preventDefault(); const todoInput = $('#new-todo-input'); if(todoInput) todoInput.focus(); } }
                if (e.key === 'Escape') { closeSettingsPanel(); }
            });

            // --- INISIALISASI & OPTIMISASI ---
            let appState; // Global state object

            function loadState() {
                const state = {};
                for (const key in STORAGE_KEYS) {
                    const storageKey = STORAGE_KEYS[key];
                    const value = localStorage.getItem(storageKey);
                    if (value) {
                        try {
                            state[key] = JSON.parse(value);
                        } catch (e) {
                            state[key] = value; // For non-JSON values
                        }
                    }
                }
                // Apply defaults
                state.colors = state.colors || { accent: '#ad1457', light: '#f48fb1', text: '#311b92' };
                state.sizes = state.sizes || { scale: '1.0' };
                state.layout = state.layout || 'center';
                state.darkMode = state.darkMode || false;
                state.font = state.font || "'Quicksand', sans-serif";
                state.uiAdvanced = state.uiAdvanced || { blur: 12, opacity: 0.25, borderWidth: 1, borderRadius: 1.5, transitionSpeed: 0.3, borderColor: 'rgba(255, 255, 255, 0.3)', textShadow: '0 1px 2px rgba(255, 255, 255, 0.4)' };
                state.elementVisibility = state.elementVisibility || { showGreeting: true, showClock: true, showSearch: true, showLinks: true };
                state.links = state.links || DEFAULT_LINKS;
                return state;
            }

            function applyThemeAndLayout(state) {
                const root = document.documentElement;
                // Theme
                root.style.setProperty('--theme-accent', state.colors.accent);
                root.style.setProperty('--theme-light', state.colors.light);
                root.style.setProperty('--theme-text', state.colors.text);
                root.style.setProperty('--theme-gradient-start', state.colors.light);
                root.style.setProperty('--theme-gradient-end', state.colors.accent);
                root.style.setProperty('--size-scale', state.sizes.scale);
                root.style.setProperty('--main-font', state.font);
                if (state.darkMode) elements.body.classList.add('dark-mode');
                // UI Advanced
                root.style.setProperty('--glass-blur', `${state.uiAdvanced.blur}px`);
                root.style.setProperty('--glass-opacity', state.uiAdvanced.opacity);
                root.style.setProperty('--glass-border-width', `${state.uiAdvanced.borderWidth}px`);
                root.style.setProperty('--glass-border-radius', `${state.uiAdvanced.borderRadius}rem`);
                root.style.setProperty('--transition-speed', `${state.uiAdvanced.transitionSpeed}s`);
                root.style.setProperty('--glass-border-color', state.uiAdvanced.borderColor);
                root.style.setProperty('--text-shadow', state.uiAdvanced.textShadow);
                // Layout
                const body = elements.body;
                const container = elements.layoutContainer;
                $('#center-panel').style.display = 'none'; $('#sidebar-panel').style.display = 'none'; $('#sidebar-main').style.display = 'none';
                $('#grid-clock').style.display = 'none'; $('#grid-search').style.display = 'none'; $('#grid-links').style.display = 'none'; $('#grid-widgets').style.display = 'none';
                body.classList.remove('layout-center', 'layout-sidebar', 'layout-grid');
                container.classList.remove('layout-center', 'layout-sidebar', 'layout-grid');
                switch (state.layout) {
                    case 'sidebar':
                        body.classList.add('layout-sidebar'); container.classList.add('layout-sidebar');
                        $('#sidebar-panel').style.display = 'block'; $('#sidebar-main').style.display = 'block';
                        $('#sidebar-main').innerHTML = $('#center-panel').innerHTML;
                        break;
                    case 'grid':
                        body.classList.add('layout-grid'); container.classList.add('layout-grid');
                        $('#grid-clock').style.display = 'block'; $('#grid-search').style.display = 'block'; $('#grid-links').style.display = 'block'; $('#grid-widgets').style.display = 'block';
                        break;
                    default:
                        body.classList.add('layout-center'); container.classList.add('layout-center'); $('#center-panel').style.display = 'block';
                        break;
                }
                // Element Visibility
                const isElementVisible = (el) => el && el.offsetParent !== null;
                if (isElementVisible(elements.clockContainer)) elements.clockContainer.style.display = (state.elementVisibility.showGreeting && state.elementVisibility.showClock) ? 'block' : 'none';
                if (isElementVisible(elements.greeting)) elements.greeting.style.display = state.elementVisibility.showGreeting ? 'block' : 'none';
                if (isElementVisible(elements.clock)) elements.clock.style.display = state.elementVisibility.showClock ? 'block' : 'none';
                if (isElementVisible(elements.date)) elements.date.style.display = state.elementVisibility.showClock ? 'block' : 'none';
                if (isElementVisible(elements.searchForm)) elements.searchForm.style.display = state.elementVisibility.showSearch ? 'flex' : 'none';
                if (isElementVisible(elements.searchFormGrid)) elements.searchFormGrid.style.display = state.elementVisibility.showSearch ? 'flex' : 'none';
                if (isElementVisible(elements.quickLinksNav)) elements.quickLinksNav.style.display = state.elementVisibility.showLinks ? 'flex' : 'none';
                if (isElementVisible(elements.gridLinksContainer)) elements.gridLinksContainer.style.display = state.elementVisibility.showLinks ? 'grid' : 'none';
            }

            function initializeCritical(state) {
                applyThemeAndLayout(state);
                Core.init();
            }

            function initializeNonCritical(state) {
                // Background
                const bgSource = state.bg || DEFAULT_BG_URL;
                const img = new Image();
                img.src = bgSource;
                img.onload = () => { elements.bgStyle.textContent = `body::before { background-image: url('${bgSource}'); }`; };
                elements.bgStatus.textContent = state.bg ? (state.bg.startsWith('data:') ? 'Menggunakan gambar lokal.' : 'Menggunakan gambar dari URL.') : 'Menggunakan gambar default.';
            }
            
            function populateSettingsForm(state) {
                elements.layoutSelect.value = state.layout;
                elements.darkModeToggle.checked = state.darkMode;
                elements.fontSelect.value = state.font;
                elements.sizeScale.value = state.sizes.scale;
                elements.colorAccent.value = state.colors.accent; updateColorPreview(elements.colorAccent, elements.previewAccent);
                elements.colorLight.value = state.colors.light; updateColorPreview(elements.colorLight, elements.previewLight);
                elements.colorText.value = state.colors.text; updateColorPreview(elements.colorText, elements.previewText);
                elements.glassBlur.value = state.uiAdvanced.blur;
                elements.glassOpacity.value = state.uiAdvanced.opacity;
                elements.glassBorderWidth.value = state.uiAdvanced.borderWidth;
                elements.glassBorderRadius.value = state.uiAdvanced.borderRadius;
                elements.transitionSpeed.value = state.uiAdvanced.transitionSpeed;
                elements.glassBorderColor.value = state.uiAdvanced.borderColor; elements.previewBorder.style.backgroundColor = state.uiAdvanced.borderColor;
                elements.showGreeting.checked = state.elementVisibility.showGreeting;
                elements.showClock.checked = state.elementVisibility.showClock;
                elements.showSearch.checked = state.elementVisibility.showSearch;
                elements.showLinks.checked = state.elementVisibility.showLinks;
                elements.customGreeting.value = state.customGreeting || '';
                elements.clockFormat.value = state.clockFormat || '12';
                elements.searchEngine.value = state.searchEngine || 'https://www.google.com/search';
                elements.rssAutoRefresh.checked = state.rssAutoRefresh || false;
                elements.linkJson.value = JSON.stringify(state.links, null, 2);
                elements.bgUrl.value = state.bg && !state.bg.startsWith('data:') ? state.bg : '';
                elements.weatherApiKey.value = state.weatherApiKey || '';
                elements.rssFeedUrl.value = state.rssUrl || '';
            }

            function attachSettingsFormListeners() {
                elements.layoutSelect.addEventListener('change', (e) => { appState.layout = e.target.value; localStorage.setItem(STORAGE_KEYS.layout, e.target.value); applyThemeAndLayout(appState); if (appState.layout === 'grid') Widgets.loadAll(); });
                elements.darkModeToggle.addEventListener('change', (e) => { appState.darkMode = e.target.checked; localStorage.setItem(STORAGE_KEYS.darkMode, e.target.checked); applyThemeAndLayout(appState); });
                elements.fontSelect.addEventListener('change', (e) => { appState.font = e.target.value; localStorage.setItem(STORAGE_KEYS.font, e.target.value); applyThemeAndLayout(appState); });
                elements.colorAccent.addEventListener('input', () => updateColorPreview(elements.colorAccent, elements.previewAccent));
                elements.colorLight.addEventListener('input', () => updateColorPreview(elements.colorLight, elements.previewLight));
                elements.colorText.addEventListener('input', () => updateColorPreview(elements.colorText, elements.previewText));
                elements.glassBorderColor.addEventListener('input', () => elements.previewBorder.style.backgroundColor = elements.glassBorderColor.value);
                elements.showGreeting.addEventListener('change', (e) => { appState.elementVisibility.showGreeting = e.target.checked; localStorage.setItem(STORAGE_KEYS.elementVisibility, JSON.stringify(appState.elementVisibility)); applyThemeAndLayout(appState); });
                elements.showClock.addEventListener('change', (e) => { appState.elementVisibility.showClock = e.target.checked; localStorage.setItem(STORAGE_KEYS.elementVisibility, JSON.stringify(appState.elementVisibility)); applyThemeAndLayout(appState); });
                elements.showSearch.addEventListener('change', (e) => { appState.elementVisibility.showSearch = e.target.checked; localStorage.setItem(STORAGE_KEYS.elementVisibility, JSON.stringify(appState.elementVisibility)); applyThemeAndLayout(appState); });
                elements.showLinks.addEventListener('change', (e) => { appState.elementVisibility.showLinks = e.target.checked; localStorage.setItem(STORAGE_KEYS.elementVisibility, JSON.stringify(appState.elementVisibility)); applyThemeAndLayout(appState); });
                
                elements.settingsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const newColors = { accent: sanitizeHex(elements.colorAccent.value), light: sanitizeHex(elements.colorLight.value), text: sanitizeHex(elements.colorText.value) };
                        if (!isValidHex(newColors.accent) || !isValidHex(newColors.light) || !isValidHex(newColors.text)) { showStatus('Format warna HEX tidak valid!', 'error'); return; }
                        appState.colors = newColors; localStorage.setItem(STORAGE_KEYS.colors, JSON.stringify(newColors));
                        const newSizes = { scale: elements.sizeScale.value }; appState.sizes = newSizes; localStorage.setItem(STORAGE_KEYS.sizes, JSON.stringify(newSizes));
                        const uiAdvancedSettings = { blur: elements.glassBlur.value, opacity: elements.glassOpacity.value, borderWidth: elements.glassBorderWidth.value, borderRadius: elements.glassBorderRadius.value, transitionSpeed: elements.transitionSpeed.value, borderColor: elements.glassBorderColor.value };
                        appState.uiAdvanced = uiAdvancedSettings; localStorage.setItem(STORAGE_KEYS.uiAdvanced, JSON.stringify(uiAdvancedSettings));
                        const elementVisSettings = { showGreeting: elements.showGreeting.checked, showClock: elements.showClock.checked, showSearch: elements.showSearch.checked, showLinks: elements.showLinks.checked };
                        appState.elementVisibility = elementVisSettings; localStorage.setItem(STORAGE_KEYS.elementVisibility, JSON.stringify(elementVisSettings));
                        appState.customGreeting = elements.customGreeting.value; localStorage.setItem(STORAGE_KEYS.customGreeting, appState.customGreeting);
                        appState.clockFormat = elements.clockFormat.value; localStorage.setItem(STORAGE_KEYS.clockFormat, appState.clockFormat);
                        appState.searchEngine = elements.searchEngine.value; localStorage.setItem(STORAGE_KEYS.searchEngine, appState.searchEngine);
                        appState.rssAutoRefresh = elements.rssAutoRefresh.checked; localStorage.setItem(STORAGE_KEYS.rssAutoRefresh, appState.rssAutoRefresh);
                        Core.updateClock();
                        const remoteUrl = elements.bgUrl.value.trim(); const localFile = elements.bgLocalFile.files[0]; let finalBgSource = '';
                        if (localFile) { finalBgSource = await readFileAsDataURL(localFile); appState.bg = finalBgSource; localStorage.setItem(STORAGE_KEYS.bg, finalBgSource); elements.bgUrl.value = ''; }
                        else if (remoteUrl) { finalBgSource = remoteUrl; appState.bg = finalBgSource; localStorage.setItem(STORAGE_KEYS.bg, finalBgSource); }
                        else { delete appState.bg; localStorage.removeItem(STORAGE_KEYS.bg); }
                        initializeNonCritical(appState);
                        const newLinkJson = elements.linkJson.value.trim();
                        if (newLinkJson) { const parsedLinks = JSON.parse(newLinkJson); if (Array.isArray(parsedLinks) && parsedLinks.every(l => l.name && l.url)) { appState.links = parsedLinks; localStorage.setItem(STORAGE_KEYS.links, newLinkJson); Core.renderLinksForCenter(parsedLinks); Core.renderLinksForGrid(parsedLinks); Core.renderLinksForSidebar(parsedLinks); } else { throw new Error("Format JSON link salah."); } }
                        else { appState.links = DEFAULT_LINKS; localStorage.removeItem(STORAGE_KEYS.links); Core.renderLinksForCenter(DEFAULT_LINKS); Core.renderLinksForGrid(DEFAULT_LINKS); Core.renderLinksForSidebar(DEFAULT_LINKS); }
                        appState.weatherApiKey = elements.weatherApiKey.value; localStorage.setItem(STORAGE_KEYS.weatherApiKey, appState.weatherApiKey);
                        appState.rssUrl = elements.rssFeedUrl.value; localStorage.setItem(STORAGE_KEYS.rssUrl, appState.rssUrl);
                        showStatus('Semua pengaturan berhasil disimpan!', 'success'); closeSettingsPanel();
                        applyThemeAndLayout(appState);
                        if (appState.layout === 'grid') Widgets.loadAll();
                    } catch (error) { showStatus('Terjadi kesalahan: ' + error.message, 'error'); console.error(error); }
                });

                elements.exportSettings.addEventListener('click', () => {
                    const settings = {};
                    Object.values(STORAGE_KEYS).forEach(key => { const value = localStorage.getItem(key); if (value) settings[key] = value; });
                    const dataStr = JSON.stringify(settings, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const exportFileDefaultName = `enchanting-startpage-settings-${new Date().toISOString().slice(0,10)}.json`;
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri); linkElement.setAttribute('download', exportFileDefaultName); linkElement.click();
                    showStatus('Pengaturan diekspor!');
                });
                elements.importSettingsFile.addEventListener('change', (e) => {
                    const file = e.target.files[0]; if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedSettings = JSON.parse(event.target.result);
                            Object.entries(importedSettings).forEach(([key, value]) => { localStorage.setItem(key, value); });
                            showStatus('Pengaturan diimpor! Halaman akan dimuat ulang.');
                            setTimeout(() => window.location.reload(), 1500);
                        } catch (error) { showStatus('Gagal mengimpor file JSON.', 'error'); }
                    };
                    reader.readAsText(file);
                });
            }

            // --- START APPLICATION ---
            appState = loadState();
            initializeCritical(appState);
            requestAnimationFrame(() => initializeNonCritical(appState));
        });
    </script>
</body>
</html>